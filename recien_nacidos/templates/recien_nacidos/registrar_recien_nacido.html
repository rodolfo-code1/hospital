{% extends 'base.html' %}

{% block title %}Registrar Recién Nacido - Sistema Trazabilidad{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-11">
        
        <div class="card shadow-lg border-0 rounded-3">
            <div class="card-header bg-success text-white py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-25 rounded-circle p-2 me-3">
                        <i class="bi bi-balloon-heart-fill fs-3"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold">Registro Clínico Neonatal</h4>
                        <small class="text-white-50">Ingreso detallado de paciente RN</small>
                    </div>
                </div>
            </div>

            <div class="card-body p-4 bg-light bg-opacity-10">
                <form method="post">
                    {% csrf_token %}

                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white pt-3 border-bottom-0">
                            <h6 class="text-uppercase text-muted fw-bold small">
                                <i class="bi bi-person-lines-fill me-1"></i> Datos Generales
                            </h6>
                        </div>
                        <div class="card-body pt-0">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-success">Parto de Origen</label>
                                    {{ form.parto }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.nombre.label_tag }}
                                    {{ form.nombre }}
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Sexo</label>
                                    {{ form.sexo }}
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Peso</label>
                                    <div class="input-group">
                                        {{ form.peso }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Talla</label>
                                    <div class="input-group">
                                        {{ form.talla }}
                                        <span class="input-group-text">cm</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">P. Cefálico</label>
                                    <div class="input-group">
                                        {{ form.perimetro_cefalico }}
                                        <span class="input-group-text">cm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-info border-opacity-25 shadow-sm mb-4">
                        <div class="card-header bg-info bg-opacity-10 pt-3 border-bottom-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="text-uppercase text-info fw-bold small mb-0">
                                    <i class="bi bi-heart-pulse-fill me-1"></i> Evaluación APGAR Detallada
                                </h6>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-lg-6 border-end">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold text-primary mb-0">Minuto 1</h6>
                                        <div class="input-group w-auto input-group-sm">
                                            <span class="input-group-text bg-primary text-white fw-bold">Total</span>
                                            {{ form.apgar_1_min }}
                                            <button type="button" class="btn btn-primary btn-calc" data-target="id_apgar_1_min">
                                                <i class="bi bi-calculator"></i> Calcular
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="d-none">
                                        {{ form.ap1_latidos }} {{ form.ap1_respiracion }} {{ form.ap1_tono }} 
                                        {{ form.ap1_reflejos }} {{ form.ap1_color }}
                                    </div>
                                    <div class="alert alert-light border small text-muted">
                                        <i class="bi bi-info-circle"></i> Use el botón "Calcular" para registrar el detalle.
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold text-success mb-0">Minuto 5</h6>
                                        <div class="input-group w-auto input-group-sm">
                                            <span class="input-group-text bg-success text-white fw-bold">Total</span>
                                            {{ form.apgar_5_min }}
                                            <button type="button" class="btn btn-success btn-calc" data-target="id_apgar_5_min">
                                                <i class="bi bi-calculator"></i> Calcular
                                            </button>
                                        </div>
                                    </div>

                                    <div class="d-none">
                                        {{ form.ap5_latidos }} {{ form.ap5_respiracion }} {{ form.ap5_tono }} 
                                        {{ form.ap5_reflejos }} {{ form.ap5_color }}
                                    </div>
                                    <div class="alert alert-light border small text-muted">
                                        <i class="bi bi-info-circle"></i> Use el botón "Calcular" para registrar el detalle.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3 pt-3 border-top align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center gap-2">
                                        <label class="form-label fw-bold small mb-0">Condición al Nacer:</label>
                                        {{ form.condicion_nacimiento }}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end d-flex align-items-center justify-content-end gap-2">
                                    <label class="small text-muted mb-0">APGAR 10' (Opcional):</label>
                                    <div style="width: 80px;">{{ form.apgar_10_min }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-white fw-bold small text-muted text-uppercase">
                                    <i class="bi bi-stars text-warning me-1"></i> Atención Inmediata
                                </div>
                                <div class="card-body d-grid gap-2">
                                    <div class="form-check form-switch bg-light p-2 rounded">
                                        {{ form.apego_piel_a_piel }}
                                        <label class="form-check-label ms-2" for="{{ form.apego_piel_a_piel.id_for_label }}">Apego Piel a Piel</label>
                                    </div>
                                    <div class="form-check form-switch bg-light p-2 rounded">
                                        {{ form.lactancia_precoz }}
                                        <label class="form-check-label ms-2" for="{{ form.lactancia_precoz.id_for_label }}">Lactancia &lt; 1 hora</label>
                                    </div>
                                    <div class="form-check form-switch bg-light p-2 rounded">
                                        {{ form.profilaxis_ocular }}
                                        <label class="form-check-label ms-2" for="{{ form.profilaxis_ocular.id_for_label }}">Profilaxis Ocular</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-white fw-bold small text-muted text-uppercase">
                                    <i class="bi bi-eyedropper text-primary me-1"></i> Inmunizaciones
                                </div>
                                <div class="card-body">
                                    <div class="p-2 border rounded bg-light mb-2">
                                        <div class="form-check mb-1">
                                            {{ form.vacuna_hepatitis_b }}
                                            <label class="form-check-label fw-bold">Hepatitis B</label>
                                        </div>
                                        <div class="ms-4">
                                            <label class="small text-muted mb-0">Responsable:</label>
                                            {{ form.responsable_vacuna_vhb }}
                                        </div>
                                    </div>
                                    <div class="p-2 border rounded bg-light">
                                        <div class="form-check">
                                            {{ form.vacuna_bcg }}
                                            <label class="form-check-label fw-bold">Vacuna BCG</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="form-check form-switch p-2 border border-danger border-opacity-25 rounded bg-danger bg-opacity-10">
                                        {{ form.requiere_derivacion }}
                                        <label class="form-check-label fw-bold text-danger ms-2">¿Requiere Traslado / Derivación?</label>
                                    </div>
                                    <div class="mt-2 ps-4">
                                        <label class="small text-muted">Lugar de destino:</label>
                                        {{ form.servicio_derivacion }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted small">EXÁMENES REALIZADOS</label>
                                    {{ form.examenes_realizados }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-muted small">OBSERVACIONES CLÍNICAS</label>
                                    {{ form.observaciones }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                        <a href="{% url 'app:home' %}" class="btn btn-light border px-4">Cancelar</a>
                        <button type="submit" class="btn btn-success px-5 shadow-sm">
                            <i class="bi bi-save me-2"></i> Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalApgar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-calculator"></i> Calculadora APGAR</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="apgar_target_input">
                <table class="table table-bordered text-center align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 25%;">Signo</th>
                            <th style="width: 25%;">0 Puntos</th>
                            <th style="width: 25%;">1 Punto</th>
                            <th style="width: 25%;">2 Puntos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="fw-bold text-start bg-light">Frecuencia Cardíaca</td>
                            <td><input type="radio" name="fc" value="0" class="btn-check apgar-radio" id="fc0"><label class="btn btn-outline-secondary w-100 py-2" for="fc0">Ausente</label></td>
                            <td><input type="radio" name="fc" value="1" class="btn-check apgar-radio" id="fc1"><label class="btn btn-outline-primary w-100 py-2" for="fc1">&lt; 100 lpm</label></td>
                            <td><input type="radio" name="fc" value="2" class="btn-check apgar-radio" id="fc2"><label class="btn btn-outline-success w-100 py-2" for="fc2">&gt; 100 lpm</label></td>
                        </tr>
                        <tr>
                            <td class="fw-bold text-start bg-light">Esfuerzo Respiratorio</td>
                            <td><input type="radio" name="resp" value="0" class="btn-check apgar-radio" id="resp0"><label class="btn btn-outline-secondary w-100 py-2" for="resp0">Ausente</label></td>
                            <td><input type="radio" name="resp" value="1" class="btn-check apgar-radio" id="resp1"><label class="btn btn-outline-primary w-100 py-2" for="resp1">Lento/Irregular</label></td>
                            <td><input type="radio" name="resp" value="2" class="btn-check apgar-radio" id="resp2"><label class="btn btn-outline-success w-100 py-2" for="resp2">Llanto fuerte</label></td>
                        </tr>
                        <tr>
                            <td class="fw-bold text-start bg-light">Tono Muscular</td>
                            <td><input type="radio" name="tono" value="0" class="btn-check apgar-radio" id="tono0"><label class="btn btn-outline-secondary w-100 py-2" for="tono0">Flácido</label></td>
                            <td><input type="radio" name="tono" value="1" class="btn-check apgar-radio" id="tono1"><label class="btn btn-outline-primary w-100 py-2" for="tono1">Cierta flexión</label></td>
                            <td><input type="radio" name="tono" value="2" class="btn-check apgar-radio" id="tono2"><label class="btn btn-outline-success w-100 py-2" for="tono2">Movimiento activo</label></td>
                        </tr>
                        <tr>
                            <td class="fw-bold text-start bg-light">Reflejos</td>
                            <td><input type="radio" name="irri" value="0" class="btn-check apgar-radio" id="irri0"><label class="btn btn-outline-secondary w-100 py-2" for="irri0">Sin respuesta</label></td>
                            <td><input type="radio" name="irri" value="1" class="btn-check apgar-radio" id="irri1"><label class="btn btn-outline-primary w-100 py-2" for="irri1">Mueca</label></td>
                            <td><input type="radio" name="irri" value="2" class="btn-check apgar-radio" id="irri2"><label class="btn btn-outline-success w-100 py-2" for="irri2">Tos/Estornudo</label></td>
                        </tr>
                        <tr>
                            <td class="fw-bold text-start bg-light">Color</td>
                            <td><input type="radio" name="col" value="0" class="btn-check apgar-radio" id="col0"><label class="btn btn-outline-secondary w-100 py-2" for="col0">Azul/Pálido</label></td>
                            <td><input type="radio" name="col" value="1" class="btn-check apgar-radio" id="col1"><label class="btn btn-outline-primary w-100 py-2" for="col1">Ext. azules</label></td>
                            <td><input type="radio" name="col" value="2" class="btn-check apgar-radio" id="col2"><label class="btn btn-outline-success w-100 py-2" for="col2">Rosado</label></td>
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <h5 class="mb-0 text-muted">Resultado:</h5>
                    <span id="apgar_total_display" class="badge bg-secondary fs-2 shadow-sm">0</span>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info text-white px-4" id="btnAplicarApgar">Aplicar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Referencia al modal
        const modalElement = document.getElementById('modalApgar');
        const modalApgar = new bootstrap.Modal(modalElement);
        let currentTargetInputId = '';
        
        // Mapeo entre inputs del modal y campos ocultos del formulario
        const mapaCampos = {
            'id_apgar_1_min': ['ap1_latidos', 'ap1_respiracion', 'ap1_tono', 'ap1_reflejos', 'ap1_color'],
            'id_apgar_5_min': ['ap5_latidos', 'ap5_respiracion', 'ap5_tono', 'ap5_reflejos', 'ap5_color']
        };

        // 1. Abrir Calculadora
        const btnCalculadoras = document.querySelectorAll('.btn-calc');
        btnCalculadoras.forEach(btn => {
            btn.addEventListener('click', function() {
                currentTargetInputId = this.getAttribute('data-target');
                // Limpiar radios del modal
                document.querySelectorAll('.apgar-radio').forEach(r => r.checked = false);
                actualizarDisplayTotal(0);
                modalApgar.show();
            });
        });

        // 2. Calcular en tiempo real
        document.querySelectorAll('.apgar-radio').forEach(radio => {
            radio.addEventListener('change', calcularTotal);
        });

        function calcularTotal() {
            let total = 0;
            const groups = ['fc', 'resp', 'tono', 'irri', 'col'];
            groups.forEach(g => {
                const selected = document.querySelector(`input[name="${g}"]:checked`);
                if (selected) total += parseInt(selected.value);
            });
            actualizarDisplayTotal(total);
        }

        function actualizarDisplayTotal(total) {
            const badge = document.getElementById('apgar_total_display');
            badge.innerText = total;
            if (total >= 7) badge.className = "badge bg-success fs-2 shadow-sm";
            else if (total >= 4) badge.className = "badge bg-warning text-dark fs-2 shadow-sm";
            else badge.className = "badge bg-danger fs-2 shadow-sm";
        }

        // 3. Aplicar resultado
        document.getElementById('btnAplicarApgar').addEventListener('click', function() {
            if (currentTargetInputId) {
                const total = document.getElementById('apgar_total_display').innerText;
                const inputTotal = document.getElementById(currentTargetInputId);
                
                // Asignar total
                if (inputTotal) inputTotal.value = total;
                
                // Asignar valores individuales a los campos ocultos
                // Esto es clave para guardar el detalle en la BD
                const camposDestino = mapaCampos[currentTargetInputId];
                const groups = ['fc', 'resp', 'tono', 'irri', 'col'];
                
                groups.forEach((g, index) => {
                    const selected = document.querySelector(`input[name="${g}"]:checked`);
                    if (selected && camposDestino) {
                        // Buscamos el radio button del formulario real que corresponde y lo marcamos
                        const nombreCampoForm = camposDestino[index]; // ej: ap1_latidos
                        const valor = selected.value;
                        
                        // Encontrar el radio del form principal con ese nombre y valor
                        const radioForm = document.querySelector(`input[name="${nombreCampoForm}"][value="${valor}"]`);
                        if(radioForm) radioForm.checked = true;
                    }
                });
            }
            modalApgar.hide();
        });
    });
</script>
{% endblock %}