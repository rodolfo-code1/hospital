{% extends 'base.html' %}

{% block title %}Detalle Alta #{{ alta.id }} - Sistema Trazabilidad{% endblock %}

{% block content %}
<div class="container py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0">
                <i class="bi bi-file-earmark-medical-fill"></i> Alta Médica #{{ alta.id }}
            </h2>
            <p class="text-muted mb-0">
                Generada el {{ alta.fecha_creacion|date:"d F Y, H:i" }}
                
                {% if alta.madre and alta.recien_nacido %}
                    <span class="badge bg-info text-dark ms-2"><i class="bi bi-people-fill"></i> Alta Conjunta</span>
                {% elif alta.madre %}
                    <span class="badge bg-primary ms-2"><i class="bi bi-person-standing-dress"></i> Solo Madre</span>
                {% elif alta.recien_nacido %}
                    <span class="badge bg-warning text-dark ms-2"><i class="bi bi-emoji-smile"></i> Solo RN</span>
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{% url 'altas:lista_altas' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list-ul"></i> Volver a la Lista
            </a>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="row g-0 text-center">
                
                <div class="col py-3 position-relative {% if alta.registros_completos %}bg-success bg-opacity-10{% else %}bg-light{% endif %}">
                    <div class="fs-3 mb-1 {% if alta.registros_completos %}text-success{% else %}text-muted{% endif %}">
                        <i class="bi bi-clipboard-check"></i>
                    </div>
                    <h6 class="fw-bold mb-0">1. Validación</h6>
                    <small class="{% if alta.registros_completos %}text-success{% else %}text-muted{% endif %}">
                        {% if alta.registros_completos %}Datos Completos{% else %}Pendiente{% endif %}
                    </small>
                </div>

                <div class="col py-3 border-start border-end position-relative {% if alta.alta_clinica_confirmada %}bg-success bg-opacity-10{% elif alta.registros_completos %}bg-warning bg-opacity-10{% else %}bg-light{% endif %}">
                    <div class="fs-3 mb-1 {% if alta.alta_clinica_confirmada %}text-success{% elif alta.registros_completos %}text-warning{% else %}text-muted{% endif %}">
                        <i class="bi bi-person-lines-fill"></i>
                    </div>
                    <h6 class="fw-bold mb-0">2. Alta Médica</h6>
                    <small class="text-muted">
                        {% if alta.alta_clinica_confirmada %}
                            <span class="text-success">{{ alta.medico_confirma }}</span>
                        {% else %}
                            Firma Pendiente
                        {% endif %}
                    </small>
                </div>

                <div class="col py-3 {% if alta.alta_administrativa_confirmada %}bg-success bg-opacity-10{% elif alta.alta_clinica_confirmada %}bg-primary bg-opacity-10{% else %}bg-light{% endif %}">
                    <div class="fs-3 mb-1 {% if alta.alta_administrativa_confirmada %}text-success{% elif alta.alta_clinica_confirmada %}text-primary{% else %}text-muted{% endif %}">
                        <i class="bi bi-building-check"></i>
                    </div>
                    <h6 class="fw-bold mb-0">3. Cierre Admin.</h6>
                    <small class="text-muted">
                        {% if alta.alta_administrativa_confirmada %}
                            <span class="text-success">{{ alta.administrativo_confirma }}</span>
                        {% else %}
                            Pendiente
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-8">
            
            {% if alta.madre %}
            <div class="card shadow-sm border-0 mb-3 border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3 text-primary">
                            <i class="bi bi-person-standing-dress fs-4"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-0">Madre: {{ alta.madre.nombre }}</h5>
                            <small class="text-muted">RUT: {{ alta.madre.rut }}</small>
                        </div>
                        <div class="ms-auto text-end">
                            <span class="badge bg-light text-dark border">Edad: {{ alta.madre.edad }}</span>
                        </div>
                    </div>
                    <div class="row g-3 small bg-light rounded p-2 mx-1">
                        <div class="col-md-4">
                            <strong class="d-block text-secondary">Previsión</strong>
                            {{ alta.madre.get_prevision_display }}
                        </div>
                        <div class="col-md-4">
                            <strong class="d-block text-secondary">CESFAM</strong>
                            {{ alta.madre.cesfam|default:"No registrado" }}
                        </div>
                        <div class="col-md-4">
                            <strong class="d-block text-secondary">Comuna</strong>
                            {{ alta.madre.comuna|default:"-" }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if alta.recien_nacido %}
            <div class="card shadow-sm border-0 mb-3 border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success bg-opacity-10 p-2 rounded-circle me-3 text-success">
                            <i class="bi bi-emoji-smile fs-4"></i>
                        </div>
                        <div>
                            <h5 class="card-title fw-bold mb-0">RN: {{ alta.recien_nacido.codigo_unico }}</h5>
                            <small class="text-muted">Sexo: {{ alta.recien_nacido.get_sexo_display }}</small>
                        </div>
                        <div class="ms-auto">
                            {% if alta.recien_nacido.peso < 2.5 %}
                                <span class="badge bg-warning text-dark">Bajo Peso</span>
                            {% else %}
                                <span class="badge bg-success">Peso Normal</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row g-3 small text-center bg-light rounded p-2 mx-1">
                        <div class="col-3 border-end">
                            <strong class="d-block text-secondary">Peso</strong>
                            {{ alta.recien_nacido.peso }} kg
                        </div>
                        <div class="col-3 border-end">
                            <strong class="d-block text-secondary">Talla</strong>
                            {{ alta.recien_nacido.talla }} cm
                        </div>
                        <div class="col-3 border-end">
                            <strong class="d-block text-secondary">CC</strong>
                            {{ alta.recien_nacido.perimetro_cefalico }} cm
                        </div>
                        <div class="col-3">
                            <strong class="d-block text-secondary">APGAR</strong>
                            {{ alta.recien_nacido.apgar_1_min }}/{{ alta.recien_nacido.apgar_5_min }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-white fw-bold">
                    <i class="bi bi-card-text me-2"></i> Observaciones del Proceso
                </div>
                <div class="card-body">
                    {% if alta.observaciones %}
                        <p class="mb-0 text-muted">{{ alta.observaciones|linebreaksbr }}</p>
                    {% else %}
                        <p class="mb-0 text-muted fst-italic">No se ingresaron observaciones adicionales.</p>
                    {% endif %}
                </div>
            </div>

        </div>

        <div class="col-lg-4">
            <div class="card shadow border-0 sticky-top" style="top: 20px; z-index: 1;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge-fill text-warning"></i> Acciones Requeridas</h5>
                </div>
                <div class="card-body d-grid gap-3">
                    
                    {% if not alta.registros_completos %}
                        <div class="alert alert-danger mb-0 small">
                            <strong><i class="bi bi-x-circle"></i> Datos Incompletos:</strong><br>
                            {{ alta.observaciones_validacion }}
                        </div>
                        <form method="post">
                            {% csrf_token %}
                            <button type="submit" name="validar" class="btn btn-warning w-100 shadow-sm fw-bold">
                                <i class="bi bi-arrow-clockwise"></i> Reintentar Validación
                            </button>
                        </form>
                    {% endif %}

                    {% if alta.puede_confirmar_alta_clinica %}
                        <div class="border-bottom pb-3">
                            <h6 class="text-muted small fw-bold text-uppercase">Paso Actual: Médico</h6>
                            {% if user.rol == 'medico' or user.rol == 'jefatura' %}
                                <a href="{% url 'altas:confirmar_alta_clinica' alta.pk %}" class="btn btn-success w-100 btn-lg shadow-sm">
                                    <i class="bi bi-pen-fill"></i> Firmar Alta Clínica
                                </a>
                            {% else %}
                                <button class="btn btn-outline-secondary w-100" disabled>
                                    <i class="bi bi-hourglass-split"></i> Esperando Firma Médica...
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if alta.puede_confirmar_alta_administrativa %}
                        <div class="border-bottom pb-3">
                            <h6 class="text-muted small fw-bold text-uppercase">Paso Actual: Administrativo</h6>
                            {% if user.rol == 'administrativo' or user.rol == 'jefatura' %}
                                <a href="{% url 'altas:confirmar_alta_administrativa' alta.pk %}" class="btn btn-primary w-100 btn-lg shadow-sm">
                                    <i class="bi bi-building-check"></i> Cerrar Alta Administrativa
                                </a>
                            {% else %}
                                <button class="btn btn-outline-secondary w-100" disabled>
                                    <i class="bi bi-hourglass-split"></i> Esperando Cierre Admin...
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if alta.esta_completada %}
                        <div class="bg-success bg-opacity-10 p-3 rounded text-center">
                            <div class="text-success fw-bold mb-2"><i class="bi bi-check-circle-fill"></i> Proceso Finalizado</div>
                            <a href="{% url 'altas:descargar_certificado' alta.pk %}" class="btn btn-danger w-100 shadow-sm" target="_blank">
                                <i class="bi bi-file-pdf-fill"></i> Descargar Certificado
                            </a>
                        </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}